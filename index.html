<!DOCTYPE html>
<html lang="vi">

  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Lý Chi Tiêu Theo Tuần</title>
    <!-- Tải Tailwind CSS cho styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      /* Định nghĩa font Inter */
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

      body {
        font-family: 'Inter', sans-serif;
        background-color: #f0f4f8;
        /* Màu nền nhẹ nhàng */
      }

      /* Tùy chỉnh thanh cuộn (scrollbar) cho giao diện thân thiện hơn */
      ::-webkit-scrollbar {
        width: 8px;
      }

      ::-webkit-scrollbar-track {
        background: #e2e8f0;
        border-radius: 10px;
      }

      ::-webkit-scrollbar-thumb {
        background: #94a3b8;
        border-radius: 10px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: #64748b;
      }
    </style>
  </head>

  <body class="flex items-center justify-center min-h-screen p-4">
    <div id="app-container" class="bg-white rounded-xl shadow-2xl p-6 md:p-8 w-full max-w-4xl">
      <h1 class="text-3xl md:text-4xl font-extrabold text-center text-blue-700 mb-6 md:mb-8">
        Quản Lý Chi Tiêu Theo Tuần
      </h1>

      <!-- Khu vực chọn tiền tệ -->
      <div class="mb-6 flex flex-col sm:flex-row items-center justify-center gap-4">
        <label for="currency-select" class="text-lg font-semibold text-gray-700">Chọn tiền tệ:</label>
        <select id="currency-select"
          class="p-2 border border-gray-300 rounded-md text-lg focus:ring-blue-500 focus:border-blue-500">
          <option value="VND">VNĐ</option>
          <option value="USD">USD</option>
          <option value="CAD">CAD</option>
        </select>
      </div>

      <!-- Khu vực điều hướng tuần -->
      <div class="mb-6 flex flex-col sm:flex-row items-center justify-center gap-4">
        <button id="prev-week-btn"
          class="bg-blue-500 text-white px-4 py-2 rounded-lg font-semibold shadow-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-opacity-75 transition duration-200 ease-in-out text-base">
          &lt; Tuần Trước
        </button>
        <span id="current-week-display" class="text-xl md:text-2xl font-bold text-gray-800 text-center flex-grow">
          Tuần: Đang tải...
        </span>
        <button id="next-week-btn"
          class="bg-blue-500 text-white px-4 py-2 rounded-lg font-semibold shadow-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-opacity-75 transition duration-200 ease-in-out text-base">
          Tuần Sau &gt;
        </button>
      </div>

      <!-- Khu vực nhập liệu cho từng ngày -->
      <div id="week-data" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
        <!-- Dữ liệu cho từng ngày sẽ được JavaScript tạo ra tại đây -->
      </div>

      <!-- Khu vực tổng kết -->
      <div id="summary-section" class="bg-blue-50 p-5 rounded-lg shadow-inner mb-6 border border-blue-200">
        <h2 class="text-xl md:text-2xl font-bold text-blue-800 mb-4 text-center">Tổng Kết Tuần</h2>
        <div class="space-y-3 text-lg md:text-xl">
          <div class="flex justify-between items-center">
            <span class="font-semibold text-gray-700">Tổng Doanh Thu:</span>
            <span id="total-revenue" class="font-bold text-green-600">0 VNĐ</span>
          </div>
          <div class="flex justify-between items-center">
            <span class="font-semibold text-gray-700">Tổng Chi Tiêu:</span>
            <span id="total-expense" class="font-bold text-red-600">0 VNĐ</span>
          </div>
          <div class="flex justify-between items-center pt-3 border-t border-blue-300">
            <span class="font-bold text-blue-800">Thu Nhập Ròng:</span>
            <span id="net-income" class="font-bold text-blue-800">0 VNĐ</span>
          </div>
        </div>
      </div>

      <!-- Khu vực điều khiển (nút bấm) -->
      <div class="controls flex flex-col sm:flex-row justify-center gap-4 mb-6">
        <button id="save-btn"
          class="bg-green-600 text-white px-6 py-3 rounded-lg font-semibold shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-75 transition duration-200 ease-in-out text-lg">
          Lưu Dữ Liệu
        </button>
        <button id="clear-btn"
          class="bg-red-600 text-white px-6 py-3 rounded-lg font-semibold shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-75 transition duration-200 ease-in-out text-lg">
          Xóa Dữ Liệu
        </button>
      </div>

      <!-- Hộp thông báo cho người dùng -->
      <div id="message-box"
        class="text-center text-lg font-medium py-3 rounded-lg transition-opacity duration-300 opacity-0">
        <!-- Thông báo sẽ hiển thị ở đây -->
      </div>
    </div>

    <script>
      // Mảng chứa tên các ngày trong tuần (Thứ Hai đến Chủ Nhật)
      const daysOfWeekNames = ['Thứ Hai', 'Thứ Ba', 'Thứ Tư', 'Thứ Năm', 'Thứ Sáu', 'Thứ Bảy', 'Chủ Nhật'];

      // Biến lưu trữ dữ liệu chi tiêu/doanh thu của tuần hiện tại
      let weeklyData = []; // Sẽ là mảng 7 đối tượng: { dayName: string, date: string, revenue: number, expense: number }

      // Biến lưu trữ loại tiền tệ đang chọn
      let selectedCurrency = 'VND';

      // Biến lưu trữ ngày đầu tiên của tuần hiện tại (luôn là Thứ Hai)
      let currentWeekStartDate = new Date(); // Sẽ được cập nhật thành Thứ Hai của tuần hiện tại

      // --- Các hàm tiện ích ---

      // Hàm định dạng số thành tiền tệ (VNĐ, USD, CAD)
      function formatCurrency(amount, currencyCode = selectedCurrency) {
        return new Intl.NumberFormat('vi-VN', {
          style: 'currency',
          currency: currencyCode,
          minimumFractionDigits: 0
        }).format(amount);
      }

      // Hàm hiển thị thông báo tạm thời cho người dùng
      function showMessage(message, type = 'info') {
        const msgBox = document.getElementById('message-box');
        msgBox.textContent = message;
        msgBox.classList.remove('opacity-0', 'bg-green-100', 'text-green-700', 'bg-red-100', 'text-red-700', 'bg-blue-100', 'text-blue-700');

        if (type === 'success') {
          msgBox.classList.add('bg-green-100', 'text-green-700');
        } else if (type === 'error') {
          msgBox.classList.add('bg-red-100', 'text-red-700');
        } else { // info
          msgBox.classList.add('bg-blue-100', 'text-blue-700');
        }
        msgBox.classList.add('opacity-100');

        setTimeout(() => {
          msgBox.classList.remove('opacity-100');
          msgBox.classList.add('opacity-0');
        }, 3000); // Ẩn sau 3 giây
      }

      // Hàm lấy ngày Thứ Hai của tuần chứa một ngày cho trước
      function getMonday(d) {
        d = new Date(d); // Tạo bản sao để không làm thay đổi ngày gốc
        const day = d.getDay(); // 0 = Chủ Nhật, 1 = Thứ Hai, ..., 6 = Thứ Bảy
        const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Điều chỉnh để Thứ Hai là ngày đầu tuần
        d.setDate(diff);
        d.setHours(0, 0, 0, 0); // Đặt về đầu ngày để tránh lỗi múi giờ
        return d;
      }

      // Hàm định dạng đối tượng Date thành chuỗi YYYY-MM-DD
      function formatDateToYYYYMMDD(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
      }

      // Hàm khởi tạo dữ liệu tuần với giá trị 0 và ngày tháng chính xác
      function initializeWeeklyData(startDate) {
        weeklyData = [];
        let currentDay = new Date(startDate); // Bắt đầu từ Thứ Hai của tuần

        for (let i = 0; i < 7; i++) {
          weeklyData.push({
            dayName: daysOfWeekNames[i],
            date: formatDateToYYYYMMDD(currentDay),
            revenue: 0,
            expense: 0
          });
          currentDay.setDate(currentDay.getDate() + 1); // Tăng ngày lên 1
        }
      }

      // Hàm cập nhật hiển thị tuần hiện tại
      function updateWeekDisplay() {
        const monday = new Date(currentWeekStartDate);
        const sunday = new Date(currentWeekStartDate);
        sunday.setDate(monday.getDate() + 6); // Chủ Nhật là 6 ngày sau Thứ Hai

        const displayString = `Tuần: ${monday.toLocaleDateString('vi-VN')} - ${sunday.toLocaleDateString('vi-VN')}`;
        document.getElementById('current-week-display').textContent = displayString;
      }

      // Hàm tạo và hiển thị các trường nhập liệu cho từng ngày
      function renderDailyInputs() {
        const weekDataContainer = document.getElementById('week-data');
        weekDataContainer.innerHTML = ''; // Xóa nội dung cũ trước khi render lại

        weeklyData.forEach((dayData, index) => {
          const dayEntry = document.createElement('div');
          dayEntry.className = 'day-entry bg-gray-50 p-4 rounded-lg shadow-sm border border-gray-200 flex flex-col space-y-2';

          // Tên ngày và Ngày cụ thể
          const dayTitle = document.createElement('h3');
          dayTitle.className = 'text-lg md:text-xl font-semibold text-gray-800 text-center mb-2';
          dayTitle.textContent = `${dayData.dayName} (${new Date(dayData.date).toLocaleDateString('vi-VN')})`;
          dayEntry.appendChild(dayTitle);

          // Input Doanh thu
          const revenueLabel = document.createElement('label');
          revenueLabel.className = 'text-gray-600 text-sm';
          revenueLabel.textContent = 'Doanh thu:';
          const revenueInput = document.createElement('input');
          revenueInput.type = 'number';
          revenueInput.min = '0';
          revenueInput.value = dayData.revenue;
          revenueInput.className = 'revenue-input w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 text-lg';
          revenueInput.placeholder = 'Nhập doanh thu';
          revenueInput.addEventListener('input', (event) => handleInputChange(event, index, 'revenue'));
          dayEntry.appendChild(revenueLabel);
          dayEntry.appendChild(revenueInput);

          // Input Chi tiêu
          const expenseLabel = document.createElement('label');
          expenseLabel.className = 'text-gray-600 text-sm mt-2';
          expenseLabel.textContent = 'Chi tiêu:';
          const expenseInput = document.createElement('input');
          expenseInput.type = 'number';
          expenseInput.min = '0';
          expenseInput.value = dayData.expense;
          expenseInput.className = 'expense-input w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 text-lg';
          expenseInput.placeholder = 'Nhập chi tiêu';
          expenseInput.addEventListener('input', (event) => handleInputChange(event, index, 'expense'));
          dayEntry.appendChild(expenseLabel);
          dayEntry.appendChild(expenseInput);

          weekDataContainer.appendChild(dayEntry);
        });
      }

      // Hàm xử lý sự kiện khi giá trị input thay đổi
      function handleInputChange(event, dayIndex, type) {
        const value = parseInt(event.target.value) || 0; // Chuyển đổi sang số nguyên, nếu không phải số thì là 0
        if (value < 0) { // Đảm bảo không nhập số âm
          event.target.value = 0;
          weeklyData[dayIndex][type] = 0;
        } else {
          weeklyData[dayIndex][type] = value;
        }
        calculateTotals(); // Tính toán lại tổng sau mỗi lần thay đổi
        saveData(); // Tự động lưu khi có thay đổi
      }

      // Hàm tính toán tổng doanh thu, tổng chi tiêu và thu nhập ròng
      function calculateTotals() {
        let totalRevenue = 0;
        let totalExpense = 0;

        weeklyData.forEach(day => {
          totalRevenue += day.revenue;
          totalExpense += day.expense;
        });

        const netIncome = totalRevenue - totalExpense;

        // Cập nhật giao diện tổng kết
        document.getElementById('total-revenue').textContent = formatCurrency(totalRevenue);
        document.getElementById('total-expense').textContent = formatCurrency(totalExpense);
        document.getElementById('net-income').textContent = formatCurrency(netIncome);

        // Thay đổi màu sắc thu nhập ròng
        const netIncomeSpan = document.getElementById('net-income');
        netIncomeSpan.classList.remove('text-green-600', 'text-red-600', 'text-blue-800');
        if (netIncome > 0) {
          netIncomeSpan.classList.add('text-green-600');
        } else if (netIncome < 0) {
          netIncomeSpan.classList.add('text-red-600');
        } else {
          netIncomeSpan.classList.add('text-blue-800');
        }
      }

      // Hàm tạo khóa lưu trữ dựa trên ngày bắt đầu tuần và loại tiền tệ
      function getStorageKey() {
        return `weeklyExpenseData_${formatDateToYYYYMMDD(currentWeekStartDate)}_${selectedCurrency}`;
      }

      // Hàm lưu dữ liệu vào Local Storage
      function saveData() {
        try {
          localStorage.setItem(getStorageKey(), JSON.stringify(weeklyData));
          localStorage.setItem('selectedCurrency', selectedCurrency); // Lưu loại tiền tệ đã chọn
          showMessage('Dữ liệu đã được lưu tự động!', 'success');
        } catch (e) {
          showMessage('Lỗi khi lưu dữ liệu. Bộ nhớ trình duyệt có thể đầy.', 'error');
          console.error("Lỗi khi lưu dữ liệu vào localStorage:", e);
        }
      }

      // Hàm tải dữ liệu từ Local Storage
      function loadData() {
        try {
          const storedData = localStorage.getItem(getStorageKey());
          if (storedData) {
            weeklyData = JSON.parse(storedData);
            showMessage('Dữ liệu đã được tải thành công!', 'success');
          } else {
            // Nếu không có dữ liệu lưu trữ cho tuần này, khởi tạo mới
            initializeWeeklyData(currentWeekStartDate);
            showMessage('Không tìm thấy dữ liệu đã lưu cho tuần này. Đã tạo dữ liệu mới.', 'info');
          }
          renderDailyInputs(); // Render lại input với dữ liệu đã tải/khởi tạo
          calculateTotals(); // Tính toán lại tổng
        } catch (e) {
          showMessage('Lỗi khi tải dữ liệu. Dữ liệu lưu trữ có thể bị hỏng.', 'error');
          console.error("Lỗi khi tải dữ liệu từ localStorage:", e);
          initializeWeeklyData(currentWeekStartDate); // Reset nếu lỗi
          renderDailyInputs();
          calculateTotals();
        }
      }

      // Hàm xóa dữ liệu của tuần hiện tại
      function clearData() {
        if (confirm('Bạn có chắc chắn muốn xóa tất cả dữ liệu của tuần hiện tại? Hành động này không thể hoàn tác.')) {
          localStorage.removeItem(getStorageKey());
          initializeWeeklyData(currentWeekStartDate); // Khởi tạo lại dữ liệu về 0
          renderDailyInputs(); // Render lại input trống
          calculateTotals(); // Tính toán lại tổng về 0
          showMessage('Dữ liệu tuần hiện tại đã được xóa!', 'info');
        }
      }

      // Hàm điều hướng tuần (trước/sau)
      function navigateToWeek(direction) {
        const oneWeek = 7 * 24 * 60 * 60 * 1000; // 1 tuần tính bằng mili giây
        if (direction === 'prev') {
          currentWeekStartDate.setTime(currentWeekStartDate.getTime() - oneWeek);
        } else { // 'next'
          currentWeekStartDate.setTime(currentWeekStartDate.getTime() + oneWeek);
        }
        // Đảm bảo currentWeekStartDate luôn là Thứ Hai của tuần đó
        currentWeekStartDate = getMonday(currentWeekStartDate);
        updateWeekDisplay(); // Cập nhật hiển thị tuần
        loadData(); // Tải dữ liệu cho tuần mới
      }

      // --- Khởi tạo ứng dụng khi trang web tải xong ---
      document.addEventListener('DOMContentLoaded', () => {
        // Lấy loại tiền tệ đã chọn từ localStorage (nếu có)
        const storedCurrency = localStorage.getItem('selectedCurrency');
        if (storedCurrency) {
          selectedCurrency = storedCurrency;
          document.getElementById('currency-select').value = storedCurrency;
        }

        // Gắn sự kiện cho dropdown chọn tiền tệ
        document.getElementById('currency-select').addEventListener('change', (event) => {
          selectedCurrency = event.target.value;
          saveData(); // Lưu loại tiền tệ mới
          calculateTotals(); // Cập nhật hiển thị tổng kết với tiền tệ mới
        });

        // Gắn sự kiện cho các nút điều hướng tuần
        document.getElementById('prev-week-btn').addEventListener('click', () => navigateToWeek('prev'));
        document.getElementById('next-week-btn').addEventListener('click', () => navigateToWeek('next'));

        // Gắn sự kiện cho các nút điều khiển chính
        document.getElementById('save-btn').addEventListener('click', saveData);
        document.getElementById('clear-btn').addEventListener('click', clearData);

        // Khởi tạo tuần hiện tại (Thứ Hai của tuần hiện tại)
        currentWeekStartDate = getMonday(new Date());
        updateWeekDisplay(); // Cập nhật hiển thị tuần ban đầu

        // Tải dữ liệu khi khởi động
        loadData();
      });
    </script>
  </body>

</html>